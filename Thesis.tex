\documentclass{mimosis}

\usepackage{lastpage}
\usepackage{metalogo}
\usepackage{tcolorbox}
\usepackage{wrapfig}

\usepackage{svg}

\usepackage{tikz}

\usepackage{todonotes}

\usepackage{needspace}
\usepackage{etoolbox}

\usepackage{minted,xpatch,letltxmacro}
\LetLtxMacro{\cminted}{\minted}
\let\endcminted\endminted
\xpretocmd{\cminted}{\RecustomVerbatimEnvironment{Verbatim}{BVerbatim}{}}{}{}
%TC:envir minted [ignore] ignore
%TC:envir cminted [ignore] ignore

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Submission
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 1. Render both the normal and anonymised versions.
% 2. Update the word count and date in the Declaration, and month in Title.

\newif\ifanonymised
% \anonymisedtrue % comment out to de-anonymise

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Listings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{listings}

\definecolor{deepblue}{rgb}{0,0,0.6}
\definecolor{deepred}{rgb}{0.6,0,0}
\definecolor{deepgreen}{rgb}{0,0.6,0}

\def\backtick{\`{}}
\newcommand\basestyle{\lstset{
    basicstyle=\small\ttfamily,
    morekeywords={self},
    keywordstyle=\color{deepblue},
    stringstyle=\color{deepgreen},
    showstringspaces=false,
    literate={`}{\backtick}1,
    escapechar=@
}}

\newcommand\ocamlstyle{\basestyle{} \lstset{language=caml}}
\lstnewenvironment{ocaml}[1][]{\ocamlstyle \lstset{#1}}{}

\newcommand\pythonstyle{\basestyle{} \lstset{language=Python}}
\lstnewenvironment{python}[1][]{\pythonstyle \lstset{#1}}{}

\newcommand\javastyle{\basestyle{} \lstset{language=Java}}
\lstnewenvironment{java}[1][]{\javastyle \lstset{#1}}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Nomenclature
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[intoc, english]{nomencl}
\makenomenclature

% https://tex.stackexchange.com/questions/383027/nomencl-package-sort-by-order-of-appearance
\providetoggle{nomsort}
\settoggle{nomsort}{false}

\makeatletter
\iftoggle{nomsort}{%
    \let\old@@@nomenclature=\@@@nomenclature        
        \newcounter{@nomcount} \setcounter{@nomcount}{0}%
        \renewcommand\the@nomcount{\two@digits{\value{@nomcount}}}% 
        \def\@@@nomenclature[#1]#2#3{% 
          \addtocounter{@nomcount}{1}%
        \def\@tempa{#2}\def\@tempb{#3}%
          \protected@write\@nomenclaturefile{}%
          {\string\nomenclatureentry{\the@nomcount\nom@verb\@tempa @[{\nom@verb\@tempa}]%
          \begingroup\nom@verb\@tempb\protect\nomeqref{\theequation}%
          |nompageref}{\thepage}}%
          \endgroup
          \@esphack}%
      }{}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hyperlinks & bookmarks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[%
  colorlinks = true,
  citecolor  = RoyalBlue,
  linkcolor  = RoyalBlue,
  urlcolor   = RoyalBlue,
  unicode,
  ]{hyperref}

\usepackage{bookmark}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Bibliography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% I like the bibliography to be extremely plain, showing only a numeric
% identifier and citing everything in simple brackets. The first names,
% if present, will be initialized. DOIs and URLs will be preserved.

\usepackage[%
  autocite     = plain,
  backend      = biber,
  doi          = true,
  url          = true,
  giveninits   = true,
  hyperref     = true,
  maxbibnames  = 99,
  maxcitenames = 99,
  sortcites    = true,
  style        = numeric,
  ]{biblatex}

\input{bibliography-mimosis}
\addbibresource{Thesis.bib}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fonts
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifxetexorluatex
  \usepackage{unicode-math}
  \setmainfont{EB Garamond}
  \setmathfont{Garamond Math}

  % Load some missing symbols from another font.
  \setmathfont{STIX Two Math}[%
    range = {
      \sharp,
      \natural,
      \flat,
      \clubsuit,
      \spadesuit,
      \checkmark
    }
  ]
  \setmonofont[Scale=MatchLowercase]{Source Code Pro}
\else
  \usepackage[lf]{ebgaramond}
  \usepackage[oldstyle,scale=0.9]{sourcecodepro}
  \singlespacing
\fi

% \newacronym{FL}{FL}{Featherweight Lua}
% \newacronym{FJ}{FJ}{Featherweight Java}

% \makeindex
% \makeglossaries

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Ordinals
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\@ifundefined{st}{%
  \newcommand{\st}{\textsuperscript{\textup{st}}\xspace}
}{}
\@ifundefined{rd}{%
  \newcommand{\rd}{\textsuperscript{\textup{rd}}\xspace}
}{}
\@ifundefined{nd}{%
  \newcommand{\nd}{\textsuperscript{\textup{nd}}\xspace}
}{}
\makeatother

\renewcommand{\th}{\textsuperscript{\textup{th}}\xspace}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Theorems
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}{Corollary}[theorem]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Incipit
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{Breaking records}
\subtitle{Language design with structural subtyping}
\author{Jakub Bachurski}

\newcommand{\candidate}[0]{2491X}
\newcommand{\authorself}{Jakub Bachurski}
\newcommand{\college}{Trinity College}

\newcommand{\coursethe}{Computer Science Tripos, Part III}
\newcommand{\coursefor}{Part III of the Computer Science Tripos}

\newcommand{\submissiondate}{June 4, 2025}
\newcommand{\submissionmonthyear}{June 2025}


\newcommand{\eg}{e.g.\@}
\newcommand{\cf}{cf.\@}
\newcommand{\ie}{i.e.\@}

\newcommand{\fabric}{\textsc{Fabric}}
\newcommand{\inference}{\textsc{Warp}}
\newcommand{\compiler}{\textsc{Weaver}}
\newcommand{\starr}{\textsc{Star}}
\newcommand{\wasm}{\textsc{WebAssembly}}
\newcommand{\mlsub}{\textsc{MLsub}}
\newcommand{\simplesub}{\textsc{Simple-sub}}
\newcommand{\mlstruct}{\textsc{MLstruct}}
\newcommand{\binaryen}{\textsc{Binaryen}}
\newcommand{\binaryendsl}{\textsc{Binaryer}}

% Since this is prior to publication and needs to be anonymised
\ifanonymised
\begin{filecontents}{star.bib}
@inproceedings{star,
  author       = {{\textit{Authors redacted to preserve submission anonymity}}},
  editor       = {Martin Elsman and Artjoms Sinkarovs},
  title        = {Structuring Arrays with Algebraic Shapes},
  booktitle    = {Proceedings of the 11th {ACM} {SIGPLAN} International Workshop on
                  Libraries, Languages and Compilers for Array Programming, {ARRAY}
                  2025, Copenhagen, Denmark, 17 June 2025},
  pages        = {1--16},
  publisher    = {{ACM}},
  year         = {2025},
  url          = {https://doi.org/10.1145/3736112.3736141},
  doi          = {10.1145/3736112.3736141},
}
\end{filecontents}
\else
\begin{filecontents}{star.bib}
@inproceedings{star,
  author       = {Bachurski, Jakub and Mycroft, Alan and Orchard, Dominic},
  editor       = {Martin Elsman and Artjoms Sinkarovs},
  title        = {Structuring Arrays with Algebraic Shapes},
  booktitle    = {Proceedings of the 11th {ACM} {SIGPLAN} International Workshop on
                  Libraries, Languages and Compilers for Array Programming, {ARRAY}
                  2025, Copenhagen, Denmark, 17 June 2025},
  pages        = {1--16},
  publisher    = {{ACM}},
  year         = {2025},
  url          = {https://doi.org/10.1145/3736112.3736141},
  doi          = {10.1145/3736112.3736141},
}
\end{filecontents}
\fi

\addbibresource{star.bib}

\begin{document}
%TC:ignore 
  \input{Sources/Notation}

\frontmatter
\ifanonymised
  \include{Sources/CoverSheet}
\else
  \include{Sources/Title}
\fi
  \include{Sources/Declaration}
  \include{Sources/Abstract}
\ifanonymised\else
  \include{Sources/Acknowledgements}
\fi

  {\hypersetup{hidelinks}
  \tableofcontents}

%TC:endignore 
\mainmatter
\label{firstcontentpage}
  \include{Sources/1-Introduction}
  \include{Sources/2-SoulOfDynamicTyping}
  \include{Sources/3-ConstraintBasedAlgebraicSubtyping}
  \include{Sources/4-Fabric}
  \include{Sources/5-Star}
\label{lastcontentpage} % Conclusions are one page
  \include{Sources/6-Conclusions}

%TC:ignore 

  % This ensures that the subsequent sections are being included as root
  % items in the bookmark structure of your PDF reader.
  \bookmarksetup{startatroot}

\begingroup
  \backmatter
  \printindex
  \printbibliography
\endgroup

\addtocontents{toc}{\protect\setcounter{tocdepth}{1}}
\setcounter{chapter}{1}
\appendix 

  \renewcommand{\nomname}{Notation}
  \printnomenclature

  \include{Sources/Appendix-FL-OpSem}
  \include{Sources/Appendix-FJ-FL_Proofs}
  % \include{Sources/Appendix-Inference_Proofs}
  \include{Sources/Appendix-FL-Constraints}
  \include{Sources/Appendix-Fabric}
  % \include{Sources/Appendix-Fabric_Examples}
  \include{Sources/Appendix-CodeGen}
  \include{Sources/Appendix-Star_Proofs}

%TC:endignore 
\end{document}